#!/usr/bin/env python
# -*- coding: utf-8 -*-
# dci-rhel-agent-ctl controls dci-rhel-agent (start, stop and kill).

import argparse
import os
import signal
import sys
import yaml

def sigterm_handler(signal, frame):
  # To do: Add support for signal (systemd stop is sigterm)
  print('Handle dci-rhel-agent stop here.')
  sys.exit(0)

signal.signal(signal.SIGTERM, sigterm_handler)

def load_settings():
  # To do: path as an arg
  with open('/etc/dci-rhel-agent/settings.yml', 'r') as settings:
    try:
      return(yaml.load(settings, Loader=yaml.SafeLoader))
    except yaml.YAMLError as exc:
      print(exc)
      sys.exit(1)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('-s', '--start', action='store_true', help="Start dci-rhel-agent")
    args = parser.parse_args()

    default_value =	{
      "local_repo": "/var/www/html"
    }

    if args.start:
        print("Starting dci-rhel-agent ...")

        settings = load_settings()
        if 'local_repo' in settings.keys():
            print ("local_repo is %s" % settings['local_repo'])
        else:
            print ("local_repo is NOT set. Using default.")
            settings['local_repo'] = default_value['local_repo']

        myCmd = 'source /etc/dci-rhel-agent/dcirc.sh &&  \
        /bin/dci-downloader --settings "/etc/dci-rhel-agent/settings.yml" && \
        podman pull quay.io/distributedci/dci-rhel-agent:stable && \
        podman run --rm -ti --network host \
        -e DCI_CLIENT_ID \
        -e DCI_API_SECRET \
        -e DCI_CS_URL \
        -v /etc/dci-rhel-agent/hooks/:/etc/dci-rhel-agent/hooks/ \
        -v /etc/dci-rhel-agent/settings.yml:/etc/dci-rhel-agent/settings.yml \
        -v /etc/dci-rhel-agent/hosts:/etc/dci-rhel-agent/hosts  \
        -v %s:/var/www/html \
        -v /etc/beaker:/etc/beaker/ \
        quay.io/distributedci/dci-rhel-agent:stable' % (settings['local_repo'])
        os.system(myCmd)

if __name__ == "__main__":
    main()