---
- name: Failure block
  block:
    - name: List all files
      shell: 'bkr job-logs {{ hostvars.localhost.bkrjobid }}'
      register: bkr_files

    - name: Ensure directory exist
      file:
        path: /tmp/joblogs
        state: directory

    - name: Ansible delete file glob
      find:
        paths: /tmp/joblogs
        patterns: '*'
      register: files_to_delete

    - name: Ansible remove file glob
      file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ files_to_delete.files }}"

    - name: Grab logs from beaker
      get_url:
        url: "{{ item }}"
        dest: /tmp/joblogs/
      with_items: "{{ bkr_files.stdout_lines }}"

    - name: Upload listed files to DCI
      dci_file:
        path: '{{ item }}'
        name: '{{ item | basename }}'
        job_id: '{{ hostvars.localhost.job_id }}'
      with_fileglob: "/tmp/joblogs/*"
  delegate_to: localhost
