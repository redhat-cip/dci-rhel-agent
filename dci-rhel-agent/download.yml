---
- name: Gather the package facts
  package_facts:
    manager: "auto"
  no_log: true

- name: Get dci-downloader version
  debug:
    msg: "{{ ansible_facts.packages['dci-downloader'][0] }}"

- name: Send settings.yml file
  copy:
    src: /etc/dci-rhel-agent/settings.yml
    dest: /tmp/settings.yml

- name: Start dci-downloader
  environment:
    - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
    - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
    - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
  shell: /bin/dci-downloader --settings /tmp/settings.yml {% if dci_rhel_agent_cert %} --debug{% endif %}
  become: true

- name: Remove temp settings file
  file:
    path: /tmp/settings.yml
    state: absent
