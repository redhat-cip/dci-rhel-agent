---
- name: Import the latest build
  shell: beaker-import -v --ignore-missing-tree-compose "http://{{ hostvars.localhost.local_repo_ip }}/{{ hostvars.localhost.topic_name }}/compose/"
  become: true

- name: Start beaker-repo-update
  ignore_errors: yes
  shell: beaker-repo-update
  become: true

#TODO: Temp workaround until RHEL-9 harness packages are availabe on beaker-project.org
- name: Ensure RHEL-8 Beaker harness packages are available for RHEL-9 provisions
  block:
    - name: Install createrepo package
      package:
        name: createrepo
        state: present

    - name: Create beaker-harness-rhel8 repo file
      yum_repository:
        name: beaker-harness-rhel8
        description: "Beaker Harness - RedHatEnterpriseLinux8"
        baseurl: https://beaker-project.org/yum/harness/RedHatEnterpriseLinux8/
        gpgkey: https://beaker-project.org/gpg/RPM-GPG-KEY-beaker-project
        enabled: no
        gpgcheck: no

    - name: Sync beaker-harness-rhel8 repo
      shell: >
        reposync -p {{ hostvars.localhost.local_repo }}/beaker/harness/RedHatEnterpriseLinux8
        -r beaker-harness-rhel8 -n --download-metadata -m -g -q -l --norepopath

    - name: Create rhel8 harness repo
      shell: createrepo -q {{ hostvars.localhost.local_repo }}/beaker/harness/RedHatEnterpriseLinux8

    - name: Remove beaker-harness-rhel8 repo file
      file:
        path: /etc/yum.repos.d/beaker-harness-rhel8.repo
        state: absent

  when: hostvars.localhost.topic_name.startswith("RHEL-9")
