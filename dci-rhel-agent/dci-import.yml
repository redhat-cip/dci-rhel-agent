---
- name: 'Read credentials from env vars'
  set_fact:
    dci_client_id="{{ lookup('env','DCI_CLIENT_ID') }}"
    dci_cs_url="{{ lookup('env','DCI_CS_URL') }}"
    skip_download="{{ lookup('env','SKIP_DOWNLOAD') }}"

- name: 'Read dci_api_secret from env vars'
  set_fact:
    dci_api_secret="{{ lookup('env','DCI_API_SECRET') }}"
  no_log: true

- name: Start dci-downloader
  delegate_to: beaker_server
  environment:
    - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
    - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
    - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
  shell: /bin/dci-downloader {{ topic }} {{ local_repo }}{% if archs is defined %}{% for arch in archs %} --arch {{arch}}{% endfor %}{% endif %}{% if variants is defined %}{% for variant in variants %} --variant {{variant}}{% endfor %}{% endif %}{% if with_debug %} --debug{% endif %}
  become: true
  when: hostvars.localhost.skip_download == False

- name: Import the latest build
  delegate_to: beaker_server
  shell: beaker-import -v --ignore-missing-tree-compose "http://{{ local_repo_ip }}/{{ topic }}/compose/"
  become: true

- name: Start beaker-repo-update
  delegate_to: beaker_server
  shell: beaker-repo-update
  become: true
