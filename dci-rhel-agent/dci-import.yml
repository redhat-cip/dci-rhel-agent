---
- name: 'Read credentials from env vars'
  set_fact:
    dci_client_id="{{ lookup('env','DCI_CLIENT_ID') }}"
    dci_cs_url="{{ lookup('env','DCI_CS_URL') }}"
    skip_download="{{ lookup('env','SKIP_DOWNLOAD') }}"

- name: 'Read dci_api_secret from env vars'
  set_fact:
    dci_api_secret="{{ lookup('env','DCI_API_SECRET') }}"
  no_log: true

- name: Get dci-downloader version
  delegate_to: beaker_server
  shell: /bin/dci-downloader --version
  when: hostvars.localhost.skip_download == False

- name: Start dci-downloader
  delegate_to: beaker_server
  environment:
    - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
    - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
    - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
  shell: /bin/dci-downloader {{ topic }} {{ local_repo }}{% if archs is defined %}{% for arch in archs %} --arch {{arch}}{% endfor %}{% endif %}{% if variants is defined %}{% for variant in variants %} --variant {{variant}}{% endfor %}{% endif %}{% if with_debug %} --debug{% endif %}
  become: true
  when: hostvars.localhost.skip_download == False

- name: Import the latest build
  delegate_to: beaker_server
  shell: beaker-import -v --ignore-missing-tree-compose "http://{{ local_repo_ip }}/{{ topic }}/compose/"
  become: true

- name: Start beaker-repo-update
  ignore_errors: yes
  delegate_to: beaker_server
  shell: beaker-repo-update
  become: true

#TODO: Temp workaround until RHEL-9 harness packages are availabe on beaker-project.org
#Must be executed after beaker-repo-update to ensure harness packages are available to copy
- name: Ensure RHEL-8 Beaker harness packages are available on jumpbox for RHEL-9 provisions
  delegate_to: beaker_server
  block:
    - name: Get list of distros in Beaker
      shell: "bkr distros-list --format json"
      register: bkr_distros_list

    - set_fact:
        distros_rhel_8_list: "{{ bkr_distros_list.stdout | from_json | json_query(\"[?contains(distro_version, 'RedHatEnterpriseLinux8')]\") }}"

    - name: Check if harness for rhel9 already exist
      find:
        paths: "{{ local_repo }}/beaker/harness"
        register: filesrhel9harness

    - name: Download RHEL-8 Distro
      environment:
        - DCI_CLIENT_ID: "{{ hostvars.localhost.dci_client_id }}"
        - DCI_API_SECRET: "{{ hostvars.localhost.dci_api_secret }}"
        - DCI_CS_URL: "{{ hostvars.localhost.dci_cs_url }}"
      shell: /bin/dci-downloader RHEL-8-milestone {{ local_repo }}
      become: true
      when: distros_rhel_8_list | length == 0
      register: downloadrhel8distro
    
    - name: Import the RHEL8 build
      shell: beaker-import -v --ignore-missing-tree-compose "http://{{ local_repo_ip }}/RHEL-8-milestone/compose/"
      become: true
      when: downloadrhel8distro.changed

    - name: Start beaker-repo-update
      ignore_errors: yes
      shell: beaker-repo-update
      become: true
      when: downloadrhel8distro.changed
      
    - name: Create directory to host RHEL-8 Beaker harness packages for RHEL-9 provisions
      file:
        path: "{{ local_repo }}/beaker/harness"
        state: directory
      when: filesrhel9harness.matched > 0

    - name: Copy RHEL-8 Beaker harness packages to local repo
      copy:
        src: /var/www/beaker/harness/RedHatEnterpriseLinux8
        dest: "{{ local_repo }}/beaker/harness"
        remote_src: yes
      when: filesrhel9harness.matched > 0
  when: topic.startswith("RHEL-9")
