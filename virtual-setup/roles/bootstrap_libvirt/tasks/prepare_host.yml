---
- name: Install needed packages
  become: true
  package:
    name:
      - libvirt
      - qemu-kvm
      - virt-install

- name: Install needed packages on EL8
  become: true
  package:
    name:
      - python3-libvirt
      - python3-lxml
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version == '8'

- name: Install needed packages on EL7
  become: true
  package:
    name:
      - python36-libvirt
      - python-lxml
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version == '7'

- name: Enable libvirt service
  become: true
  service:
    name: libvirtd
    enabled: yes
    state: started

- name: Add user to libvirt and qemu groups
  become: true
  user:
    name: "{{ ansible_user_id }}"
    append: yes
    groups:
      - libvirt
      - qemu

- name: Set fact ssh_key
  set_fact:
    host_ssh_key_path: "~/.ssh/{{ ssh_key | default('id_rsa_rhel_ci') }}"

- name: Generate a new ssh key
  community.crypto.openssh_keypair:
    path: "{{ host_ssh_key_path }}"
  register: host_ssh_key

- name: Add id_rsa_rhel_ci key to authorized key
  authorized_key:
    user: "{{ ansible_user_id }}"
    state: present
    key: "{{ host_ssh_key.public_key }}"

- name: Create the folder to share rhel_topics between the host and the Jumpbox
  become: true
  file:
    path: /opt/rhel_topics
    state: directory
    owner: "{{ ansible_user_id }}"
    mode: '0755'