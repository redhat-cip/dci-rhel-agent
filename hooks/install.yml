---
#- name: Import the last build
#  host: beaker-lab
#  shell: beaker-import http://{{ IP AGENT }}/rhel/

- name: create temporary file
  tempfile:
    state: file
    suffix: xml
  register: job_xml

- name: get information from treeinfo
  set_fact:
    distro_name: "{{ lookup('ini', 'name section=general file={{ local_repo }}/{{ topic }}/.treeinfo') }}"
    distro_arch: "{{ lookup('ini', 'arch section=general file={{ local_repo }}/{{ topic }}/.treeinfo') }}"

- name: create job.xml file
  template:
    src: /usr/share/dci-rhel-agent/templates/job.xml.j2
    dest: "{{ job_xml.path }}"

- name: upload job.xml to DCI
  dci_file:
    path: "{{ job_xml.path }}"
    name: 'job.xml'
    mime: 'text/xml'
    job_id: '{{ job_id }}'

- name: launch beaker install
  shell: "bkr job-submit {{ job_xml.path }}"
  register: bkr_jobid

- debug:
    msg: '{{ bkr_jobid }}'

- name: Register Beaker Job ID
  set_fact:
    bkrjobid: "{{ bkr_jobid.stdout | regex_replace(\".*\\s\\[\\'(.*)\\'\\]\",'\\1') }}"

- name: Get Beaker job details
  shell: "bkr job-results {{ bkrjobid }}"
  register: bkr_job_results

- name: Parse XML to find where job is scheduled
  xml:
    xmlstring: '{{ bkr_job_results.stdout }}'
    xpath: /job/recipeSet/recipe/roles/role/system/@value
  register: bkr_host

- debug:
    msg: '{{ bkr_host }}'

#- name: attach to job
#  shell: 'bkr job-watch {{ bkrjobid }}'

- name: Wait system to be reserved
  shell: "{{ playbook_dir }}/hooks/wait.py {{ bkrjobid }}"
